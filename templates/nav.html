<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Навигация по музею</title>
    <link rel="stylesheet" href="../static/styles/styles.css">
</head>
<body>
    <header class="header">
        <h1>Навигация по музею</h1>
    </header>

    <main class="main-content">
        <section class="qr-section">
            <h2>Сканируйте QR-код</h2>
            <video id="camera" autoplay></video>
            <button id="capture">Сделать снимок</button>
            <canvas id="canvas" style="display:none;"></canvas>
            <p id="current-hall">Вы находитесь в: <span id="hall-name">—</span></p>
        </section>

        <section class="navigation-section">
            <h2>Выберите зал</h2>
            <select id="hall-select">
                <option value="">Выберите зал...</option>
            </select>
            <button id="findRoute">Показать маршрут</button>
            <p id="shortest-path"></p>
        </section>
    </main>

    <script>
        const video = document.getElementById('camera');
        const canvas = document.getElementById('canvas');
        const captureButton = document.getElementById('capture');
        const hallName = document.getElementById('hall-name');

        // Адрес сервера Flask
        const SERVER_URL = "http://127.0.0.1:5000/scan_qr";  // ЗАМЕНИ, если сервер на хостинге

        // Запрашиваем доступ к камере
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                video.srcObject = stream;
                video.play();
            })
            .catch(error => {
                console.error("Ошибка доступа к камере", error);
                alert("Не удалось получить доступ к камере. Проверьте настройки браузера.");
            });

        captureButton.addEventListener('click', async () => {
            const context = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            // Преобразуем снимок в Blob и отправляем на сервер
            canvas.toBlob(async (blob) => {
                const formData = new FormData();
                formData.append('image', blob, 'qr-code.jpg');

                try {
                    const response = await fetch(SERVER_URL, {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        throw new Error(`Ошибка сервера: ${response.status}`);
                    }

                    const data = await response.json();
                    hallName.textContent = data.hall || "Не удалось распознать QR-код";
                } catch (error) {
                    console.error("Ошибка при отправке изображения", error);
                    alert("Не удалось отправить изображение. Проверьте соединение.");
                }
            }, 'image/jpeg');
        });
    </script>
</body>
</html>
